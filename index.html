<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PLAKKS-like Flick Soccer (Debug Robust)</title>
  <style>
    html,body{height:100%;margin:0;background:#0b1220;color:#eaf0ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .wrap{height:100%;display:flex;flex-direction:column;padding:12px;gap:10px;max-width:1200px;margin:0 auto;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);}
    .top b{font-size:14px}
    .hud{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    button{cursor:pointer;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#eaf0ff;padding:8px 10px;border-radius:12px;font-weight:700}
    button:active{transform:translateY(1px)}
    .shell{position:relative;flex:1;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);overflow:hidden;min-height:520px}
    canvas{position:absolute;inset:0;width:100%;height:100%;display:block;background:#091022}
    .dbg{position:absolute;left:12px;top:12px;z-index:10;padding:8px 10px;border-radius:12px;
         background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.12);font:600 12px/1.35 system-ui}
    .err{position:absolute;left:12px;bottom:12px;z-index:10;padding:8px 10px;border-radius:12px;display:none;
         background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.12);color:#ffe4e6;font:700 12px/1.35 system-ui;max-width:min(900px,calc(100% - 24px))}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div><b>PLAKKS-like Flick Soccer</b> <span style="opacity:.7;font-weight:600">— debug robust</span></div>
    <div class="hud">
      <button id="reset">Reiniciar</button>
    </div>
  </div>

  <div class="shell" id="shell">
    <canvas id="c"></canvas>
    <div class="dbg" id="dbg">dbg…</div>
    <div class="err" id="err"></div>
  </div>
</div>

<script>
(() => {
  const CONFIG = {
    world: { w: 1200, h: 720 },
    render: { pitchMargin: 28, pitchCornerR: 38, grassNoise: 0.06 },
  };

  const canvas = document.getElementById('c');
  const shell = document.getElementById('shell');
  const dbg = document.getElementById('dbg');
  const errBox = document.getElementById('err');
  const ctx = canvas.getContext('2d');

  function showErr(e){
    errBox.style.display='block';
    errBox.textContent = 'ERROR: ' + (e?.stack || e?.message || String(e));
  }

  function resize(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const r = shell.getBoundingClientRect();
    const w = Math.max(300, Math.floor(r.width * dpr));
    const h = Math.max(300, Math.floor(r.height * dpr));
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w; canvas.height = h;
    }
    const pad = CONFIG.render.pitchMargin * dpr;
    const sx = (w - pad*2) / CONFIG.world.w;
    const sy = (h - pad*2) / CONFIG.world.h;
    const scale = Math.max(0.0001, Math.min(sx, sy));
    const ox = (w - CONFIG.world.w * scale) * 0.5;
    const oy = (h - CONFIG.world.h * scale) * 0.5;
    return { dpr,w,h,scale,ox,oy };
  }

  // Dibujo mínimo obligatorio (si NO aparece, el problema es tu entorno/layout)
  function drawSanity(m){
    ctx.clearRect(0,0,m.w,m.h);
    // fondo
    ctx.fillStyle = '#081020';
    ctx.fillRect(0,0,m.w,m.h);

    // rectángulo verde (sanity)
    ctx.fillStyle = '#0f6b3c';
    ctx.fillRect(20*m.dpr, 20*m.dpr, 260*m.dpr, 90*m.dpr);

    ctx.fillStyle = '#eaf0ff';
    ctx.font = `${Math.floor(14*m.dpr)}px system-ui`;
    ctx.fillText('SANITY DRAW OK', 30*m.dpr, 55*m.dpr);
  }

  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  function drawPitch(m){
    const W = CONFIG.world.w, H = CONFIG.world.h;
    const x0 = m.ox, y0 = m.oy, s = m.scale;

    // césped
    const g = ctx.createLinearGradient(x0,y0,x0+W*s,y0+H*s);
    g.addColorStop(0,'#0f6b3c');
    g.addColorStop(0.5,'#0e5f37');
    g.addColorStop(1,'#0b4a2c');
    ctx.fillStyle = g;
    roundRect(x0,y0,W*s,H*s,CONFIG.render.pitchCornerR*m.dpr);
    ctx.fill();

    // líneas
    ctx.lineWidth = 3*m.dpr;
    ctx.strokeStyle = 'rgba(245,255,245,.85)';
    roundRect(x0+2*m.dpr,y0+2*m.dpr,W*s-4*m.dpr,H*s-4*m.dpr,(CONFIG.render.pitchCornerR-6)*m.dpr);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(x0 + (W*s)/2, y0);
    ctx.lineTo(x0 + (W*s)/2, y0 + H*s);
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(x0 + (W*s)/2, y0 + (H*s)/2, 110*s, 0, Math.PI*2);
    ctx.stroke();

    // texto demo
    ctx.fillStyle='rgba(255,255,255,.9)';
    ctx.font = `${Math.floor(14*m.dpr)}px system-ui`;
    ctx.fillText('Si ves este campo, el canvas está OK.', x0 + 18*m.dpr, y0 + 26*m.dpr);
  }

  let last = performance.now();
  function loop(){
    try{
      const m = resize();

      // 1) sanity
      drawSanity(m);

      // 2) dibujo real encima (si esto falla, ya lo sabremos)
      drawPitch(m);

      const now = performance.now();
      const fps = 1000 / Math.max(1, (now - last));
      last = now;

      dbg.textContent =
        `canvas: ${m.w}×${m.h} (dpr ${m.dpr.toFixed(2)}) | scale: ${m.scale.toFixed(4)} | fps≈${fps.toFixed(0)}`;

      requestAnimationFrame(loop);
    }catch(e){
      showErr(e);
    }
  }

  document.getElementById('reset').addEventListener('click', () => {
    errBox.style.display='none';
  });

  loop();
})();
</script>
</body>
</html>
